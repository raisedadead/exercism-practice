name: Keep PR Branches Updated

on:
  schedule:
    # Run twice daily to keep PRs up to date
    - cron: '0 0,12 * * *'
  workflow_dispatch:
    # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  update-prs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Update PR branches that are behind
        run: |
          echo "Fetching all open PRs from trusted users..."
          
          # Get all open PRs from trusted users
          gh pr list --state open --json number,author,isDraft,headRefName,baseRefName | \
          jq -r '.[] | select(.isDraft == false) | select(.author.login == "raisedadead" or .author.login == "renovate[bot]" or .author.login == "exercism-solutions-syncer[bot]") | "\(.number)|\(.headRefName)|\(.baseRefName)"' | \
          while IFS='|' read -r pr_number head_ref base_ref; do
            echo ""
            echo "=== Processing PR #$pr_number (${head_ref} -> ${base_ref}) ==="
            
            # Check if PR is behind the base branch
            merge_state=$(gh pr view $pr_number --json mergeStateStatus -q .mergeStateStatus)
            mergeable=$(gh pr view $pr_number --json mergeable -q .mergeable)
            
            echo "  Merge state: $merge_state"
            echo "  Mergeable: $mergeable"
            
            if [ "$merge_state" = "BEHIND" ] && [ "$mergeable" = "MERGEABLE" ]; then
              echo "  PR is behind but mergeable, updating branch..."
              
              # Fetch latest changes
              git fetch origin "$base_ref:$base_ref" || true
              git fetch origin "$head_ref:$head_ref" || true
              
              # Checkout the PR branch
              git checkout "$head_ref" || {
                echo "  Failed to checkout $head_ref, skipping"
                continue
              }
              
              # Rebase onto the base branch
              if git rebase "origin/$base_ref"; then
                echo "  Rebase successful, pushing..."
                if git push --force-with-lease origin "$head_ref"; then
                  echo "  ✓ Successfully updated PR #$pr_number"
                else
                  echo "  ✗ Failed to push updates for PR #$pr_number"
                fi
              else
                echo "  ✗ Rebase failed for PR #$pr_number (likely has conflicts)"
                git rebase --abort 2>/dev/null || true
              fi
              
              # Return to main branch
              git checkout "$base_ref" 2>/dev/null || git checkout main 2>/dev/null || true
            else
              echo "  PR is up to date or not auto-updateable (state: $merge_state, mergeable: $mergeable)"
            fi
          done
          
          echo ""
          echo "=== Update process complete ==="
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
